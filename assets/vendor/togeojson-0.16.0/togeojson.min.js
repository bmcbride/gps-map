var toGeoJSON=function(){"use strict";var t,r=/\s*/g,i=/^\s*|\s*$/g,o=/\s+/;function p(e){if(!e||!e.length)return 0;for(var t=0,r=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t)|0;return r}function L(e,t){return e.getElementsByTagName(t)}function N(e,t){return e.getAttribute(t)}function s(e,t){return parseFloat(N(e,t))}function M(e,t){t=L(e,t);return t.length?t[0]:null}function c(e){for(var t=0,r=[];t<e.length;t++)r[t]=parseFloat(e[t]);return r}function P(e){var t;return e&&(t=e).normalize&&t.normalize(),e&&e.textContent||""}function f(e,t){for(var r,n={},i=0;i<t.length;i++)(r=M(e,t[i]))&&(n[t[i]]=P(r));return n}function m(e,t){for(var r in t)e[r]=t[r]}function F(e){return c(e.replace(r,"").split(","))}function w(e){for(var t=e.replace(i,"").split(o),r=[],n=0;n<t.length;n++)r.push(F(t[n]));return r}function y(e){var t=[s(e,"lon"),s(e,"lat")],r=M(e,"ele"),n=M(e,"gpxtpx:hr")||M(e,"hr"),e=M(e,"time");return r&&(r=parseFloat(P(r)),isNaN(r)||t.push(r)),{coordinates:t,time:e?P(e):null,heartRate:n?parseFloat(P(n)):null}}function d(){return{type:"FeatureCollection",features:[]}}function R(e){return void 0!==e.xml?e.xml:t.serializeToString(e)}return"undefined"!=typeof XMLSerializer?t=new XMLSerializer:"object"!=typeof exports||"object"!=typeof process||process.browser||(t=new(require("xmldom").XMLSerializer)),{kml:function(e){for(var t=d(),v={},S={},k={},T=["Polygon","LineString","Point","Track","gx:Track"],r=L(e,"Placemark"),n=L(e,"Style"),i=L(e,"StyleMap"),o=0;o<n.length;o++){var s=p(R(n[o])).toString(16);v["#"+N(n[o],"id")]=s,S[s]=n[o]}for(var a=0;a<i.length;a++){v["#"+N(i[a],"id")]=p(R(i[a])).toString(16);for(var l=L(i[a],"Pair"),u={},g=0;g<l.length;g++)u[P(M(l[g],"key"))]=P(M(l[g],"styleUrl"));k["#"+N(i[a],"id")]=u}for(var h=0;h<r.length;h++)t.features=t.features.concat(function(e){var t,r=function e(t){var r,n,i,o,s=[],a=[];if(M(t,"MultiGeometry"))return e(M(t,"MultiGeometry"));if(M(t,"MultiTrack"))return e(M(t,"MultiTrack"));if(M(t,"gx:MultiTrack"))return e(M(t,"gx:MultiTrack"));for(n=0;n<T.length;n++)if(r=L(t,T[n]))for(i=0;i<r.length;i++)if(g=r[i],"Point"===T[n])s.push({type:"Point",coordinates:F(P(M(g,"coordinates")))});else if("LineString"===T[n])s.push({type:"LineString",coordinates:w(P(M(g,"coordinates")))});else if("Polygon"===T[n]){var l=L(g,"LinearRing"),u=[];for(o=0;o<l.length;o++)u.push(w(P(M(l[o],"coordinates"))));s.push({type:"Polygon",coordinates:u})}else{var g;"Track"!==T[n]&&"gx:Track"!==T[n]||(g=x(g),s.push({type:"LineString",coordinates:g.coords}),g.times.length&&a.push(g.times))}return{geoms:s,coordTimes:a}}(e),n={},i=P(M(e,"name")),o=P(M(e,"styleUrl")),s=P(M(e,"description")),a=M(e,"TimeSpan"),l=M(e,"TimeStamp"),u=M(e,"ExtendedData"),g=M(e,"LineStyle"),h=M(e,"PolyStyle"),p=M(e,"visibility");if(!r.geoms.length)return[];i&&(n.name=i);o&&("#"!==o[0]&&(o="#"+o),n.styleUrl=o,v[o]&&(n.styleHash=v[o]),k[o]&&(n.styleMapHash=k[o],n.styleHash=v[k[o].normal]),(o=S[n.styleHash])&&(g=g||M(o,"LineStyle"),h=h||M(o,"PolyStyle")));s&&(n.description=s);a&&(s=P(M(a,"begin")),a=P(M(a,"end")),n.timespan={begin:s,end:a});l&&(n.timestamp=P(M(l,"when")));g&&(f=b(P(M(g,"color"))),m=f[0],c=f[1],f=parseFloat(P(M(g,"width"))),m&&(n.stroke=m),isNaN(c)||(n["stroke-opacity"]=c),isNaN(f)||(n["stroke-width"]=f));{var c,f,m;h&&(m=b(P(M(h,"color"))),c=m[0],f=m[1],m=P(M(h,"fill")),h=P(M(h,"outline")),c&&(n.fill=c),isNaN(f)||(n["fill-opacity"]=f),m&&(n["fill-opacity"]="1"===m?n["fill-opacity"]||1:0),h&&(n["stroke-opacity"]="1"===h?n["stroke-opacity"]||1:0))}if(u){var y=L(u,"Data"),d=L(u,"SimpleData");for(t=0;t<y.length;t++)n[y[t].getAttribute("name")]=P(M(y[t],"value"));for(t=0;t<d.length;t++)n[d[t].getAttribute("name")]=P(d[t])}p&&(n.visibility=P(p));r.coordTimes.length&&(n.coordTimes=1===r.coordTimes.length?r.coordTimes[0]:r.coordTimes);r={type:"Feature",geometry:1===r.geoms.length?r.geoms[0]:{type:"GeometryCollection",geometries:r.geoms},properties:n};N(e,"id")&&(r.id=N(e,"id"));return[r]}(r[h]));function b(e){var t,r;return 6!==(e="#"===(e=e||"").substr(0,1)?e.substr(1):e).length&&3!==e.length||(t=e),8===e.length&&(r=parseInt(e.substr(0,2),16)/255,t="#"+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)),[t,isNaN(r)?void 0:r]}function x(e){var t=L(e,"coord"),r=[],n=[];0===t.length&&(t=L(e,"gx:coord"));for(var i=0;i<t.length;i++)r.push(c(P(t[i]).split(" ")));for(var o=L(e,"when"),s=0;s<o.length;s++)n.push(P(o[s]));return{coords:r,times:n}}return t},gpx:function(e){for(var t,r,n,i,o,s=L(e,"trk"),a=L(e,"rte"),l=L(e,"wpt"),u=d(),g=0;g<s.length;g++)(t=function(e){for(var t,r=L(e,"trkseg"),n=[],i=[],o=[],s=0;s<r.length;s++)(t=h(r[s],"trkpt"))&&(t.line&&n.push(t.line),t.times&&t.times.length&&i.push(t.times),t.heartRates&&t.heartRates.length&&o.push(t.heartRates));if(0===n.length)return;e=p(e);i.length&&(e.coordTimes=1===n.length?i[0]:i);o.length&&(e.heartRates=1===n.length?o[0]:o);return{type:"Feature",properties:e,geometry:{type:1===n.length?"LineString":"MultiLineString",coordinates:1===n.length?n[0]:n}}}(s[g]))&&u.features.push(t);for(g=0;g<a.length;g++)r=a[g],n=void 0,(t=(n=h(r,"rtept")).line?{type:"Feature",properties:p(r),geometry:{type:"LineString",coordinates:n.line}}:void 0)&&u.features.push(t);for(g=0;g<l.length;g++)u.features.push((i=l[g],o=void 0,m(o=p(i),f(i,["sym","type"])),{type:"Feature",properties:o,geometry:{type:"Point",coordinates:y(i).coordinates}}));function h(e,t){var r=L(e,t),n=[],i=[],o=[],s=r.length;if(s<2)return{};for(var a=0;a<s;a++){var l=y(r[a]);n.push(l.coordinates),l.time&&i.push(l.time),l.heartRate&&o.push(l.heartRate)}return{line:n,times:i,heartRates:o}}function p(e){var t=f(e,["name","cmt","desc","time","keywords"]),r=L(e,"link");r.length&&(t.links=[]);for(var n,i=0;i<r.length;i++)m(n={href:N(r[i],"href")},f(r[i],["text","type"])),t.links.push(n);return t}return u}}}();"undefined"!=typeof module&&(module.exports=toGeoJSON);